---

- name: Create postgres dir
  file:
    path: '{{ QUAY_ROOT_DIR }}/postgres-quay'
    state: directory

- name: Set postgres dir ACL
  ansible.posix.acl:
    path: '{{ QUAY_ROOT_DIR }}/postgres-quay'
    entry: u:26:-wx
    state: present

- name: Start postgres container
  containers.podman.podman_container:
    name: postgresql-quay
    image: registry.redhat.io/rhel8/postgresql-10:1
    state: started
    restart: yes
    restart_policy: "always"
    ports:
        - "5432:5432"
    env:
        POSTGRESQL_USER: "quayuser"
        POSTGRESQL_PASSWORD: "quaypass"
        POSTGRESQL_DATABASE: "quay"
        POSTGRESQL_ADMIN_PASSWORD: "adminpass"
    volume:
      - "{{ QUAY_ROOT_DIR }}/postgres-quay:/var/lib/pgsql/data:Z"

- name: Wait for postgres to start
  ansible.builtin.pause:
    seconds: 6

- name: Enable pg_trgm
  command: >
    podman exec -it postgresql-quay /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS pg_trgm" | psql -d quay -U postgres'
