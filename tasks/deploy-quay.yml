---

- name: "Create quay config directory"
  file:
    state: directory
    path: "/opt/quay/config"
  tags:
    - quay

- name: "Create extra_ca_certs directory"
  file:
    state: directory
    path: "/opt/quay/config/extra_ca_certs"
  tags:
    - quay

- name: "Create quay storage directory (when object storage is not available)"
  file:
    state: directory
    path: "/opt/quay/storage"
  tags:
    - quay

- name: Copy quay template in place
  template:
    src: config.yaml.j2
    dest: '/opt/quay/config/config.yaml'

- name: Copy certs in place
  copy:
    src: '{{ item }}'
    dest: '/opt/quay/config/{{ item }}'
  with_items:
    - 'ssl.cert'
    - 'ssl.key'

- name: Start quay
  containers.podman.podman_container:
    name: quay
    image: registry.redhat.io/quay/quay-rhel8:v3.5.1
    state: started
    restart: yes
    restart_policy: "always"
    sysctl:
      net.core.somaxconn: 4096
    ports:
        - "8080:8080"
        - "443:8443"
    volume:
        - "/opt/quay/config:/conf/stack:Z"
        - "/opt/quay/storage:/datastorage:Z"
  tags:
    - quay
